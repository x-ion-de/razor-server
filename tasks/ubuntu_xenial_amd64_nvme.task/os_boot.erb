#!/bin/bash

exec >> /var/log/razor.log 2>&1

<%= render_template("set_hostname") %>

sleep 60

# APT configuration and system update
cat << EOF > /etc/apt/sources.list
# Autogenerated by razor installation
deb http://repo.x-ion.de/ubuntu xenial main
deb http://security.ubuntu.com/ubuntu xenial-security main universe
EOF

curl http://repo.x-ion.de/pubkey.gpg | apt-key add -

apt-get -y update
[ "$?" -eq 0 ] || curl -s <%= log_url("apt_update_fail", :error) %>

apt-get -y upgrade
[ "$?" -eq 0 ] || curl -s <%= log_url("apt_upgrade_fail", :error) %>

apt-get -y dist-upgrade
[ "$?" -eq 0 ] || curl -s <%= log_url("apt_dist_upgrade_fail", :error) %>


<%= render_template("store_ip") %>

<%= render_template("os_complete") %>

# Send final state
curl -s <%= stage_done_url("finished") %>
